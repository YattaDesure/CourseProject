#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ Docker –Ω–∞ –Ω–æ—É—Ç–±—É–∫–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start-db-tunnel.sh [ngrok|cloudflared]

TUNNEL_TYPE=${1:-ngrok}

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è SQL Server –≤ Docker (–ø–æ—Ä—Ç 1433)"
echo "–¢–∏–ø —Ç—É–Ω–Ω–µ–ª—è: $TUNNEL_TYPE"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ë–î –∑–∞–ø—É—â–µ–Ω
if ! docker ps | grep -q "1433"; then
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ö–æ–∂–µ, —á—Ç–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å SQL Server –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç—É–Ω–Ω–µ–ª—è:"
    echo "  docker-compose up -d sqlserver"
    echo "  –∏–ª–∏"
    echo "  docker start <–∏–º—è-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

if [ "$TUNNEL_TYPE" = "ngrok" ]; then
    echo "üì° –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è..."
    echo "‚ö†Ô∏è  –ê–¥—Ä–µ—Å –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ!"
    echo ""
    echo "–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
    echo ""
    ngrok tcp 1433
elif [ "$TUNNEL_TYPE" = "cloudflared" ]; then
    echo "üì° –ó–∞–ø—É—Å–∫ cloudflared —Ç—É–Ω–Ω–µ–ª—è..."
    echo "‚ö†Ô∏è  –ê–¥—Ä–µ—Å –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è —ç—Ç–æ–≥–æ —Ç—É–Ω–Ω–µ–ª—è."
    echo ""
    cloudflared tunnel --url tcp://localhost:1433
else
    echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ç—É–Ω–Ω–µ–ª—è: $TUNNEL_TYPE"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start-db-tunnel.sh [ngrok|cloudflared]"
    exit 1
fi

